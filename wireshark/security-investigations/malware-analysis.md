# Wireshark Malware and Security Investigation Laboratory

## ðŸŽ¯ **Investigation Overview**
This advanced laboratory demonstrates professional malware analysis and security investigation techniques using Wireshark for enterprise incident response, threat hunting, and digital forensics applications.

## ðŸ”’ **Cybersecurity Investigation Framework**

### **Incident Response Methodology**
```
1. Preparation
   â”œâ”€â”€ Establish monitoring capabilities
   â”œâ”€â”€ Develop investigation procedures
   â””â”€â”€ Prepare analysis tools and techniques

2. Identification
   â”œâ”€â”€ Detect security incidents
   â”œâ”€â”€ Assess scope and impact
   â””â”€â”€ Preserve evidence integrity

3. Containment
   â”œâ”€â”€ Isolate affected systems
   â”œâ”€â”€ Prevent lateral movement
   â””â”€â”€ Maintain business continuity

4. Eradication
   â”œâ”€â”€ Remove malicious artifacts
   â”œâ”€â”€ Patch vulnerabilities
   â””â”€â”€ Strengthen security controls

5. Recovery
   â”œâ”€â”€ Restore normal operations
   â”œâ”€â”€ Monitor for recurrence
   â””â”€â”€ Validate system integrity

6. Lessons Learned
   â”œâ”€â”€ Document investigation findings
   â”œâ”€â”€ Improve security processes
   â””â”€â”€ Update threat intelligence
```

## ðŸ¦  **Malware Communication Analysis**

### **Command and Control (C2) Detection**

#### **C2 Traffic Characteristics**
```wireshark
# Suspicious communication patterns
tcp.flags.push == 1 and tcp.len < 100        # Small command packets
tcp.stream eq X and tcp.time_delta > 30      # Periodic beaconing
http.user_agent matches ".*bot.*|.*crawler.*" # Suspicious user agents
dns.qry.name matches ".*\.tk$|.*\.ml$|.*\.cf$" # Suspicious TLDs
```

#### **HTTP-based C2 Analysis**
```wireshark
# HTTP C2 indicators
http.request.method == "POST" and http.content_length < 50  # Small POST requests
http.request.uri contains "/gate" or http.request.uri contains "/panel"
http.response.code == 404 and tcp.len > 100  # 404 with content (steganography)
http.cookie contains "PHPSESSID" and tcp.len < 10  # Cookie-based commands
```

#### **DNS-based C2 Detection**
```wireshark
# DNS tunneling and C2
dns.qry.name matches ".*\\..*\\..*\\..*\\..*\\." # Excessive subdomains
dns.resp.len > 100                            # Large DNS responses
dns.qry.type == 16                            # TXT record queries
dns.qry.name contains "base64" or dns.qry.name matches "[0-9a-f]{32,}"
```

### **Advanced Persistent Threat (APT) Indicators**

#### **Lateral Movement Detection**
```wireshark
# Internal reconnaissance and movement
smb2.cmd == 3 and smb2.tree contains "ADMIN$"  # Administrative shares
smb2.cmd == 5 and smb2.filename contains ".exe" # Executable transfers
kerberos.msg_type == 10                        # TGS requests (Golden Ticket)
dcerpc.cn_flags.fragmented == 1                # RPC fragmentation (evasion)
```

#### **Data Exfiltration Patterns**
```wireshark
# Large data transfers
tcp.len > 1460 and tcp.flags.push == 1        # Full segments with PUSH
ftp.request.command == "STOR"                 # FTP uploads
http.request.method == "POST" and http.content_length > 50000
smb2.cmd == 9 and smb2.file_info.size > 1000000  # Large file reads
```

## ðŸ•µï¸ **Digital Forensics Analysis**

### **Timeline Reconstruction**

#### **Network Event Correlation**
```wireshark
# Chronological analysis filters
frame.time >= "2024-01-15 09:00:00" and frame.time <= "2024-01-15 17:00:00"
tcp.flags.syn == 1                            # Connection establishments
dhcp.option.dhcp == 1                         # DHCP discoveries
arp.opcode == 1                                # ARP requests
```

#### **User Activity Tracking**
```wireshark
# User behavior analysis
http.host and http.request.uri                # Web browsing activity
smtp.req.command == "MAIL" or smtp.req.command == "RCPT"  # Email activity
smb2.tree and smb2.filename                   # File system access
ldap.protocolOp == 0                           # LDAP authentication
```

### **Evidence Preservation and Chain of Custody**

#### **Capture File Integrity**
```bash
# Generate file hashes for integrity verification
md5sum capture_file.pcap > capture_file.md5
sha256sum capture_file.pcap > capture_file.sha256

# Document capture conditions
echo "Capture Date: $(date)" > capture_metadata.txt
echo "Capture Interface: eth0" >> capture_metadata.txt
echo "Capture Duration: 30 minutes" >> capture_metadata.txt
echo "Investigator: [Name]" >> capture_metadata.txt
```

#### **Evidence Documentation Template**
```markdown
## Digital Evidence Log

**Case Number**: [Incident ID]
**Evidence Item**: [Capture file name]
**Collection Date/Time**: [Timestamp]
**Collection Method**: [Tool and technique]
**Chain of Custody**: [Handler information]

### File Integrity
- **MD5 Hash**: [Hash value]
- **SHA256 Hash**: [Hash value]
- **File Size**: [Size in bytes]

### Capture Details
- **Source Interface**: [Network interface]
- **Capture Filter**: [Applied filters]
- **Capture Duration**: [Time period]
- **Total Packets**: [Packet count]
```

## ðŸŽ­ **Advanced Evasion Techniques Detection**

### **Protocol Tunneling and Steganography**

#### **DNS Tunneling Detection**
```wireshark
# DNS tunneling indicators
dns.qry.name matches "[0-9a-f]{20,}"          # Hex-encoded data
dns.response.ttl < 60                         # Low TTL values
dns.qry.type == 16 and dns.txt_length > 100   # Large TXT records
dns.flags.response == 0 and dns.count.queries > 1  # Multiple queries
```

#### **ICMP Tunneling Analysis**
```wireshark
# ICMP covert channels
icmp.type == 8 and icmp.data_len > 56         # Oversized ping data
icmp.type == 0 and icmp.data_len > 56         # Oversized ping replies
icmp.data matches "[0-9a-f]{16,}"             # Hex data in ICMP
data.len > 100 and icmp                       # Large ICMP payloads
```

### **Encryption and Obfuscation Analysis**

#### **TLS/SSL Analysis**
```wireshark
# TLS inspection points
tls.handshake.type == 1                       # Client Hello
tls.handshake.extensions_server_name          # SNI analysis
tls.handshake.ciphersuite                     # Cipher selection
tls.record.content_type == 23 and tls.record.length > 1000  # Large app data
```

#### **HTTP Header Analysis**
```wireshark
# Suspicious HTTP headers
http.user_agent == ""                         # Empty user agent
http.referer contains "javascript:"           # XSS attempts
http.request.line contains "../"              # Directory traversal
http.content_encoding == "gzip" and http.content_length < 50  # Compressed commands
```

## ðŸ” **Threat Intelligence Integration**

### **IOC (Indicators of Compromise) Analysis**

#### **IP Reputation Analysis**
```wireshark
# Known malicious IPs (example filters)
ip.src == 185.220.100.240 or ip.dst == 185.220.100.240  # Known C2 IP
ip.src_host contains "tor-exit" or ip.dst_host contains "tor-exit"
ip.geoip.country == "XX"                      # Countries of interest
tcp.dstport in {6666,6667,6697}               # IRC ports
```

#### **Domain Analysis**
```wireshark
# Suspicious domain patterns
dns.qry.name contains "dga-" or dns.qry.name matches "^[a-z]{8,}\\.[a-z]{2,3}$"
http.host matches ".*[0-9]{4,}.*"             # Domains with many numbers
tls.handshake.extensions_server_name matches ".*bit\\.ly.*|.*tinyurl.*"
```

### **Behavioral Analysis Patterns**

#### **Automated Traffic Detection**
```wireshark
# Bot-like behavior indicators
tcp.time_delta > 60 and tcp.time_delta < 65   # Regular intervals
http.request.method == "GET" and tcp.time_delta > 300  # Periodic HTTP
tcp.window_size == 65535                      # Fixed window sizes
http.content_length == 0 and http.response.code == 200  # Empty responses
```

#### **Human vs. Machine Traffic**
```wireshark
# Human behavior indicators
http.request.method == "GET" and http.referer  # Normal browsing
tcp.time_delta < 0.1                          # Human-like timing
http.user_agent contains "Mozilla" and http.accept_language
http.cookie and http.request.method == "POST" # Interactive sessions
```

## ðŸ›¡ï¸ **Advanced Security Analysis Techniques**

### **Network Baseline Deviation Analysis**

#### **Statistical Analysis**
```wireshark
# Statistical anomalies
Statistics > Protocol Hierarchy               # Protocol distribution
Statistics > Conversations                    # Communication patterns
Statistics > Endpoints                        # Active hosts analysis
Statistics > I/O Graph                        # Traffic volume patterns
```

#### **Custom Filters for Anomaly Detection**
```wireshark
# Unusual traffic patterns
tcp.port < 1024 and tcp.flags.syn == 1       # Privileged port scans
udp.port > 50000                             # High ephemeral ports
tcp.window_size < 1024                       # Unusually small windows
frame.len > 1514                             # Jumbo frames
```

### **Memory and Process Analysis Correlation**

#### **Network-to-Host Correlation**
```bash
# Correlate network traffic with system logs
# Extract timestamps for correlation
tshark -r capture.pcap -T fields -e frame.time -e ip.src -e ip.dst -e tcp.dstport

# Match with system process information
# Example: correlate with running processes
ps aux | grep [suspicious_process]
netstat -tulpn | grep [suspicious_port]
```

## ðŸ“Š **Forensic Reporting and Documentation**

### **Investigation Report Template**
```markdown
## Malware Investigation Report

### Executive Summary
- **Incident Type**: [Malware family/attack type]
- **Severity Level**: [Critical/High/Medium/Low]
- **Affected Systems**: [System count and criticality]
- **Business Impact**: [Operational and financial impact]

### Technical Analysis
#### Network IOCs Identified
- **C2 Servers**: [IP addresses and domains]
- **Communication Protocols**: [HTTP, DNS, etc.]
- **Payload Characteristics**: [Size, frequency, encryption]
- **Lateral Movement**: [Internal propagation methods]

#### Timeline of Events
1. **Initial Compromise**: [First detection timestamp]
2. **C2 Establishment**: [Communication start time]
3. **Reconnaissance**: [Internal scanning activity]
4. **Data Collection**: [File access and staging]
5. **Exfiltration**: [Data transfer attempts]

#### Eradication Actions
- **Network Controls**: [Firewall rules, DNS blocks]
- **Host Remediation**: [Malware removal, patching]
- **Monitoring Enhancement**: [Additional detection rules]

### Recommendations
1. **Immediate Actions**: [Urgent security measures]
2. **Short-term Improvements**: [30-day improvements]
3. **Long-term Strategy**: [Strategic security enhancements]
```

### **Technical Evidence Package**
```bash
# Evidence package structure
investigation_package/
â”œâ”€â”€ capture_files/
â”‚   â”œâ”€â”€ initial_compromise.pcap
â”‚   â”œâ”€â”€ c2_communication.pcap
â”‚   â””â”€â”€ data_exfiltration.pcap
â”œâ”€â”€ analysis_results/
â”‚   â”œâ”€â”€ ioc_list.txt
â”‚   â”œâ”€â”€ timeline.csv
â”‚   â””â”€â”€ network_diagram.png
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ extraction_scripts.py
â”‚   â””â”€â”€ analysis_filters.txt
â””â”€â”€ documentation/
    â”œâ”€â”€ investigation_report.md
    â”œâ”€â”€ chain_of_custody.pdf
    â””â”€â”€ technical_appendix.md
```

## ðŸ”§ **Automation and Scripting**

### **Python Analysis Scripts**
```python
#!/usr/bin/env python3
"""
Automated malware communication analysis
Extract C2 indicators from packet captures
"""

import pyshark
import ipaddress
from collections import defaultdict

def analyze_c2_patterns(pcap_file):
    """Identify potential C2 communication patterns"""
    
    # Communication statistics
    connections = defaultdict(list)
    suspicious_domains = []
    
    # Open capture file
    cap = pyshark.FileCapture(pcap_file)
    
    for packet in cap:
        try:
            # HTTP-based C2 detection
            if hasattr(packet, 'http'):
                if hasattr(packet.http, 'user_agent'):
                    ua = packet.http.user_agent
                    if any(keyword in ua.lower() for keyword in ['bot', 'crawler', 'wget']):
                        print(f"Suspicious User-Agent: {ua}")
                
                if hasattr(packet.http, 'host'):
                    host = packet.http.host
                    # Check for suspicious domain patterns
                    if len(host.split('.')[0]) > 15 or host.endswith(('.tk', '.ml', '.cf')):
                        suspicious_domains.append(host)
            
            # DNS tunneling detection
            if hasattr(packet, 'dns'):
                if hasattr(packet.dns, 'qry_name'):
                    domain = packet.dns.qry_name
                    # Check for hex-encoded subdomains
                    subdomains = domain.split('.')
                    for subdomain in subdomains:
                        if len(subdomain) > 20 and all(c in '0123456789abcdef' for c in subdomain):
                            print(f"Potential DNS tunneling: {domain}")
        
        except AttributeError:
            continue
    
    cap.close()
    
    # Generate report
    print("\n=== C2 Analysis Results ===")
    print(f"Suspicious domains found: {len(set(suspicious_domains))}")
    for domain in set(suspicious_domains):
        print(f"  - {domain}")

if __name__ == "__main__":
    analyze_c2_patterns("malware_traffic.pcap")
```

### **Automated IOC Extraction**
```bash
#!/bin/bash
# Extract IOCs from Wireshark capture

PCAP_FILE=$1
OUTPUT_DIR="ioc_extraction"

mkdir -p $OUTPUT_DIR

# Extract unique IP addresses
tshark -r $PCAP_FILE -T fields -e ip.src -e ip.dst | \
    sort -u | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' > $OUTPUT_DIR/ip_addresses.txt

# Extract DNS queries
tshark -r $PCAP_FILE -Y "dns.flags.response == 0" -T fields -e dns.qry.name | \
    sort -u > $OUTPUT_DIR/dns_queries.txt

# Extract HTTP hosts
tshark -r $PCAP_FILE -Y "http.host" -T fields -e http.host | \
    sort -u > $OUTPUT_DIR/http_hosts.txt

# Extract User-Agents
tshark -r $PCAP_FILE -Y "http.user_agent" -T fields -e http.user_agent | \
    sort -u > $OUTPUT_DIR/user_agents.txt

echo "IOC extraction complete. Results in $OUTPUT_DIR/"
```

## ðŸŽ“ **Professional Development Applications**

### **Cybersecurity Certifications**
- **GCIH (GIAC Certified Incident Handler)**: Incident response and forensics
- **GCFA (GIAC Certified Forensic Analyst)**: Digital forensics and analysis
- **GNFA (GIAC Network Forensic Analyst)**: Network-based forensic analysis
- **GSEC (GIAC Security Essentials)**: General security knowledge and analysis

### **Career Applications**
- **SOC Analyst**: Security event analysis and threat detection
- **Incident Response Specialist**: Malware investigation and containment
- **Digital Forensics Examiner**: Evidence analysis and court testimony
- **Threat Hunter**: Proactive threat identification and analysis
- **Cybersecurity Consultant**: Client security assessment and recommendations

---

**Related Investigations**: [Network Troubleshooting](../analysis-scenarios/network-troubleshooting-lab.md), [Protocol Analysis](../protocol-labs/), [Performance Analysis](../analysis-scenarios/network-performance-analysis.md)
